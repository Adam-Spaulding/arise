{"version":3,"names":[],"mappings":"","sources":["services/offer.js"],"sourcesContent":["'use strict';\r\n\r\napp.factory('Offer', function(FURL, $firebase, $q, Auth, Task) {\r\n\tvar ref = new Firebase(FURL);\r\n\tvar user = Auth.user;\r\n\r\n\tvar Offer = {\r\n\t\toffers: function(taskId) {\r\n\t\t\treturn $firebase(ref.child('offers').child(taskId)).$asArray();\r\n\t\t},\r\n\r\n\t\tmakeOffer: function(taskId, offer) {\r\n\t\t\tvar task_offers = this.offers(taskId);\r\n\r\n\t\t\tif(task_offers) {\r\n\t\t\t\treturn task_offers.$add(offer);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\t// This function is to check if the login user already made offer for this task.\r\n\t\t// This to prevent a user from offering more than 1.\r\n\t\tisOfferred: function(taskId) {\r\n\r\n\t\t\tif(user && user.provider) {\r\n\t\t\t\tvar d = $q.defer();\r\n\r\n\t\t\t\t$firebase(ref.child('offers').child(taskId).orderByChild(\"uid\")\r\n\t\t\t\t\t.equalTo(user.uid))\r\n\t\t\t\t\t.$asArray()\r\n\t\t\t\t\t.$loaded().then(function(data) {\r\n\t\t\t\t\t\td.resolve(data.length > 0);\r\n\t\t\t\t\t}, function() {\r\n\t\t\t\t\t\td.reject(false);\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\treturn d.promise;\r\n\t\t\t}\r\n\r\n\t\t},\r\n\r\n\t\tisMaker: function(offer) {\r\n\t\t\treturn (user && user.provider && user.uid === offer.uid);\r\n\t\t},\r\n\r\n\t\tgetOffer: function(taskId, offerId) {\r\n\t\t\treturn $firebase(ref.child('offers').child(taskId).child(offerId));\r\n\t\t},\r\n\r\n\t\tcancelOffer: function(taskId, offerId) {\r\n\t\t\treturn this.getOffer(taskId, offerId).$remove();\r\n\t\t},\r\n\r\n\t\t//-----------------------------------------------//\r\n\r\n\t\tacceptOffer: function(taskId, offerId, runnerId) {\r\n\t\t\t// Step 1: Update Offer with accepted = true\r\n\t\t\tvar o = this.getOffer(taskId, offerId);\r\n\t\t\treturn o.$update({accepted: true})\r\n\t\t\t\t.then(function() {\r\n\r\n\t\t\t\t\t// Step 2: Update Task with status = \"assigned\" and runnerId\r\n\t\t\t\t\tvar t = Task.getTask(taskId);\r\n\t\t\t\t\treturn t.$update({status: \"assigned\", runner: runnerId});\r\n\t\t\t\t})\r\n\t\t\t\t.then(function() {\r\n\r\n\t\t\t\t\t// Step 3: Create User-Tasks lookup record for use in Dashboard\r\n\t\t\t\t\treturn Task.createUserTasks(taskId);\r\n\t\t\t\t});\r\n\t\t},\r\n\r\n\t\tnotifyRunner: function(taskId, runnerId) {\r\n\t\t\t// Get runner's profile\r\n\t\t\tAuth.getProfile(runnerId).$loaded().then(function(runner) {\r\n\t\t\t\tvar n = {\r\n\t\t\t\t\ttaskId: taskId,\r\n\t\t\t\t\temail: runner.email,\r\n\t\t\t\t\tname: runner.name\r\n\t\t\t\t};\r\n\r\n\t\t\t\t// Create Notification and Zapier will delete it after use.\r\n\t\t\t\tvar notification = $firebase(ref.child('notifications')).$asArray();\r\n\t\t\t\treturn notification.$add(n);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t};\r\n\r\n\treturn Offer;\r\n\r\n})\r\n"],"file":"offer.js"}