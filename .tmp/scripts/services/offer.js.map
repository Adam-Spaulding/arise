{"version":3,"names":[],"mappings":"","sources":["services/offer.js"],"sourcesContent":["'use strict';\n\napp.factory('Offer', function(FURL, $firebase, $q, Auth, Task) {\n\tvar ref = new Firebase(FURL);\n\tvar user = Auth.user;\n\n\tvar Offer = {\n\t\toffers: function(taskId) {\n\t\t\treturn $firebase(ref.child('offers').child(taskId)).$asArray();\n\t\t},\n\n\t\tmakeOffer: function(taskId, offer) {\n\t\t\tvar task_offers = this.offers(taskId);\n\n\t\t\tif(task_offers) {\n\t\t\t\treturn task_offers.$add(offer);\n\t\t\t}\n\t\t},\n\n\t\t// This function is to check if the login user already made offer for this task.\n\t\t// This to prevent a user from offering more than 1.\n\t\tisOfferred: function(taskId) {\n\n\t\t\tif(user && user.provider) {\n\t\t\t\tvar d = $q.defer();\n\n\t\t\t\t$firebase(ref.child('offers').child(taskId).orderByChild(\"uid\")\n\t\t\t\t\t.equalTo(user.uid))\n\t\t\t\t\t.$asArray()\n\t\t\t\t\t.$loaded().then(function(data) {\n\t\t\t\t\t\td.resolve(data.length > 0);\n\t\t\t\t\t}, function() {\n\t\t\t\t\t\td.reject(false);\n\t\t\t\t\t});\n\n\t\t\t\treturn d.promise;\n\t\t\t}\n\n\t\t},\n\n\t\tisMaker: function(offer) {\n\t\t\treturn (user && user.provider && user.uid === offer.uid);\n\t\t},\n\n\t\tgetOffer: function(taskId, offerId) {\n\t\t\treturn $firebase(ref.child('offers').child(taskId).child(offerId));\n\t\t},\n\n\t\tcancelOffer: function(taskId, offerId) {\n\t\t\treturn this.getOffer(taskId, offerId).$remove();\n\t\t},\n\n\t\t//-----------------------------------------------//\n\n\t\tacceptOffer: function(taskId, offerId, runnerId) {\n\t\t\t// Step 1: Update Offer with accepted = true\n\t\t\tvar o = this.getOffer(taskId, offerId);\n\t\t\treturn o.$update({accepted: true})\n\t\t\t\t.then(function() {\n\n\t\t\t\t\t// Step 2: Update Task with status = \"assigned\" and runnerId\n\t\t\t\t\tvar t = Task.getTask(taskId);\n\t\t\t\t\treturn t.$update({status: \"assigned\", runner: runnerId});\n\t\t\t\t})\n\t\t\t\t.then(function() {\n\n\t\t\t\t\t// Step 3: Create User-Tasks lookup record for use in Dashboard\n\t\t\t\t\treturn Task.createUserTasks(taskId);\n\t\t\t\t});\n\t\t},\n\n\t\tnotifyRunner: function(taskId, runnerId) {\n\t\t\t// Get runner's profile\n\t\t\tAuth.getProfile(runnerId).$loaded().then(function(runner) {\n\t\t\t\tvar n = {\n\t\t\t\t\ttaskId: taskId,\n\t\t\t\t\temail: runner.email,\n\t\t\t\t\tname: runner.name\n\t\t\t\t};\n\n\t\t\t\t// Create Notification and Zapier will delete it after use.\n\t\t\t\tvar notification = $firebase(ref.child('notifications')).$asArray();\n\t\t\t\treturn notification.$add(n);\n\t\t\t});\n\t\t}\n\n\t};\n\n\treturn Offer;\n\n})\n"],"file":"offer.js"}